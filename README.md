# instrumented-lambda

There are several tools available to help AWS Lambda function developers understand what is happening in their functions.

Why is this important?

By their very nature, AWS Lambda functions are ephemeral and do not provide shell access. It is not possible to connect to a AWS Lambda execution environment and debug.

The tools that we'll look at include:

* [AWS Lambda Powertools](https://awslabs.github.io/aws-lambda-powertools-python/)

* [AWS Distro for OpenTelemetry](https://aws-otel.github.io/docs/getting-started/lambda)

* [Amazon CloudWatch Lambda Insights](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Lambda-Insights.html)

Each of these tools has a _slightly_ different purpose.

| Tool                         | Purpose | Mechanism |
|------------------------------|---------|-----------|
| AWS Lambda Powertools        | A suite of utilities for AWS Lambda functions to ease adopting best practices such as tracing, structured logging, custom metrics, idempotency, batching, and more.     | Code Modules | 
| AWS Distro for OpenTelemetry | Provides a plug-and-play user experience by automatically instrumenting a Lambda function, by packaging OpenTelemetry together with an out-of-the-box configuration for AWS Lambda and AWS X-Ray.| Lambda Extension    |
| Amazon CloudWatch Lambda Insights          | CloudWatch Lambda Insights is a monitoring and troubleshooting solution for serverless applications running on AWS Lambda. The solution collects, aggregates, and summarizes system-level metrics including CPU time, memory, disk, and network. It also collects, aggregates, and summarizes diagnostic information such as cold starts and Lambda worker shutdowns to help you isolate issues with your Lambda functions and resolve them quickly.  | Lambda Extension    |

The functions themselves are _very_ simple. Remember, this is an exercise to look at observability options.

# Pre-requisites

* python3.9

* [AWS SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html)

# Building Your Functions

The SAM CLI can build your AWS Lambda functions in a suitable format so they can be built and tested locally or deployed to an AWS account.

```bash
sam build
```

# Invoking Your Functions Locally

The SAM CLI can invoke your functions locally using the following syntax:

## Invoking the PowerTools Function

```bash
sam local invoke PowertoolsFunction --region [your-aws-region] --profile [your-aws-profile]
```

## Invoking the OTEL Function

```bash
sam local invoke OtelFunction--region [your-aws-region] --profile [your-aws-profile]
```

## Invoking the Lambda Insights Function

```bash
sam local invoke InsightsFunction--region [your-aws-region] --profile [your-aws-profile]
```

# Deploying Your Functions

```bash
sam deploy --guided --region [your-aws-region] --profile [your-aws-profile]
```

**NOTE:** Store the output file generated by `sam deploy` (default: _samconfig.toml_). Subsequent deploys can use the simplified `sam config`.

# References

| Name | Type |
| :--- | :--- |
| [OpenTelemetry Docs](https://opentelemetry.io/docs/) | Docs |
| [AWS Distro for OpenTelemetry Lambda](https://aws-otel.github.io/docs/getting-started/lambda) | Docs |
| [open-telemetry/opentelemetry-lambda](https://github.com/open-telemetry/opentelemetry-lambda/) | Code |
| [Auto-instrumenting a Python application with an AWS Distro for OpenTelemetry Lambda layer](https://aws.amazon.com/blogs/opensource/auto-instrumenting-a-python-application-with-an-aws-distro-for-opentelemetry-lambda-layer/) | Blog |
| [AWS Lambda Powertools for Python](https://awslabs.github.io/aws-lambda-powertools-python) | Code |
| [Using Lambda Insights in Amazon CloudWatch](https://docs.aws.amazon.com/lambda/latest/dg/monitoring-insights.html) | Docs |
